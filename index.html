<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Search</title>
    <style>
        :root {
            --yt-background: #0f0f0f;
            --yt-surface: #212121;
            --yt-border: #303030;
            --yt-text-primary: #fff;
            --yt-text-secondary: #aaa;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--yt-background);
            color: var(--yt-text-primary);
            margin: 0;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: var(--yt-surface);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { display: flex; align-items: center; }
        .logo img { height: 25px; margin-right: 15px; }
        .search-bar { display: flex; flex-grow: 1; max-width: 600px; }
        .search-bar input {
            width: 100%;
            padding: 10px;
            background-color: #121212;
            border: 1px solid var(--yt-border);
            border-radius: 40px 0 0 40px;
            color: var(--yt-text-primary);
            font-size: 16px;
        }
        .search-bar button {
            padding: 10px 20px;
            background-color: var(--yt-border);
            border: 1px solid var(--yt-border);
            border-left: none;
            border-radius: 0 40px 40px 0;
            cursor: pointer;
        }
        main { padding: 20px; }
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .video-item { cursor: pointer; }
        .thumbnail img {
            width: 100%;
            border-radius: 12px;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }
        .video-details { display: flex; margin-top: 12px; }
        .channel-avatar { margin-right: 12px; }
        .channel-avatar img { width: 36px; height: 36px; border-radius: 50%; }
        .video-title { font-size: 16px; font-weight: 500; line-height: 22px; margin: 0 0 4px 0; color: var(--yt-text-primary); }
        .video-meta { font-size: 14px; color: var(--yt-text-secondary); }
        #loader { text-align: center; font-size: 1.2em; display: none; padding: 40px; }

        /* Player View */
        #player-view { display: none; padding: 20px; max-width: 1280px; margin: auto; }
        #player-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            margin-bottom: 15px;
        }
        #player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video-info h2 { margin-top: 0; font-size: 20px; }
        .video-stats { display: flex; align-items: center; color: var(--yt-text-secondary); font-size: 14px; margin-bottom: 15px; }
        .video-stats span { margin-right: 15px; }
        #channel-info { display: flex; align-items: center; margin-bottom: 20px; }
        #channel-info img { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; }
        #channel-name { font-size: 16px; font-weight: 500; }
        #subscriber-count { font-size: 12px; color: var(--yt-text-secondary); }
        #video-description {
            background: var(--yt-surface);
            padding: 15px;
            border-radius: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        #comments-section { margin-top: 30px; }
        .comment-item { display: flex; margin-bottom: 20px; }
        .comment-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; }
        .comment-content p { margin: 0; }
        .comment-author { font-weight: 500; margin-bottom: 5px; }
        #back-button {
            background: var(--yt-border);
            color: var(--yt-text-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo">
            <img src="https://www.gstatic.com/youtube/img/branding/youtubelogo/svg/youtubelogo.svg" alt="YouTube Logo">
        </div>
        <div class="search-bar">
            <input type="text" id="query" placeholder="Search">
            <button id="search-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" focusable="false" style="pointer-events: none; display: block; width: 100%; height: 100%; fill: #fff;"><path d="M20.87,20.17l-5.59-5.59C16.35,13.35,17,11.75,17,10c0-3.87-3.13-7-7-7s-7,3.13-7,7s3.13,7,7,7c1.75,0,3.35-0.65,4.58-1.71 l5.59,5.59L20.87,20.17z M10,16c-3.31,0-6-2.69-6-6s2.69-6,6-6s6,2.69,6,6S13.31,16,10,16z"></path></svg>
            </button>
        </div>
    </header>

    <main id="main-view">
        <div id="loader">Loading...</div>
        <div id="results"></div>
    </main>

    <div id="player-view">
        <button id="back-button">&larr; Back to results</button>
        <div id="player-container"></div>
        <div id="video-info">
            <h2 id="video-title-player"></h2>
            <div class="video-stats">
                <span id="view-count"></span>
                <span id="upload-date"></span>
                <span id="like-count"></span>
            </div>
            <div id="channel-info">
                <img id="channel-avatar-player" src="" alt="Channel Avatar">
                <div>
                    <div id="channel-name"></div>
                    <div id="subscriber-count"></div>
                </div>
            </div>
            <div id="video-description"></div>
        </div>
        <div id="comments-section">
            <h3>Comments</h3>
            <div id="comments-list"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const YOUTUBE_API_KEY = "AIzaSyBZKN7j0rj22Da7uTbY0E-SIHSn3WGlgZ4";
        const API_BASE = "https://www.googleapis.com/youtube/v3/";

        const queryInput = document.getElementById('query');
        const searchBtn = document.getElementById('search-btn');
        const resultsDiv = document.getElementById('results');
        const loader = document.getElementById('loader');
        const mainView = document.getElementById('main-view');
        const playerView = document.getElementById('player-view');
        const backButton = document.getElementById('back-button');

        let nextPageToken = null;
        let currentQuery = '';
        let isLoadingMore = false;
        let player;
        let videoIdToLoad = null;

        function onYouTubeIframeAPIReady() {
            if (videoIdToLoad) {
                createPlayer(videoIdToLoad);
            }
        }

        function createPlayer(videoId) {
            player = new YT.Player('player-container', {
                height: '360',
                width: '640',
                videoId: videoId,
            });
        }

        searchBtn.addEventListener('click', () => handleSearch(true));
        queryInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleSearch(true);
        });
        backButton.addEventListener('click', showMainView);

        window.addEventListener('scroll', () => {
            if (isLoadingMore || !nextPageToken || playerView.style.display === 'block') return;
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                handleSearch(false);
            }
        });

        async function handleSearch(isNewSearch) {
            if (isNewSearch) {
                currentQuery = queryInput.value.trim();
                if (!currentQuery) return;
                nextPageToken = null;
                resultsDiv.innerHTML = '';
            }
            
            isLoadingMore = true;
            loader.style.display = 'block';

            try {
                const searchResult = await fetchSearchData(currentQuery, nextPageToken);
                if (searchResult.error) throw new Error(searchResult.error);
                displayResults(searchResult.items);
                nextPageToken = searchResult.nextPageToken;
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red; text-align: center;">Error: ${error.message}</p>`;
            } finally {
                isLoadingMore = false;
                loader.style.display = 'none';
            }
        }

        async function displayResults(items) {
            if (!items || items.length === 0) {
                if (!resultsDiv.hasChildNodes()) {
                    resultsDiv.innerHTML = '<p style="text-align: center;">No results found.</p>';
                }
                return;
            }

            const channelIds = items.map(item => item.channelId).filter((id, index, self) => id && self.indexOf(id) === index);
            const channelAvatars = await getChannelAvatars(channelIds);

            items.forEach(item => {
                const videoElement = document.createElement('div');
                videoElement.className = 'video-item';
                videoElement.onclick = () => watchVideo(item.videoId);
                const avatarUrl = channelAvatars[item.channelId] || '';

                videoElement.innerHTML = `
                    <div class="thumbnail"><img src="${item.imageUrl}" alt="${item.title}"></div>
                    <div class="video-details">
                        <div class="channel-avatar"><img src="${avatarUrl}" alt="${item.channel}"></div>
                        <div>
                            <h3 class="video-title">${item.title}</h3>
                            <div class="video-meta">
                                <p>${item.channel}</p>
                                <p>${formatViews(item.views)} views</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.appendChild(videoElement);
            });
        }

        async function watchVideo(videoId) {
            mainView.style.display = 'none';
            playerView.style.display = 'block';
            window.scrollTo(0, 0);

            // Clear previous video content and show loading state
            document.getElementById('video-title-player').textContent = 'Loading...';
            document.getElementById('video-description').textContent = '';
            document.getElementById('comments-list').innerHTML = '';
            document.getElementById('view-count').textContent = '';
            document.getElementById('upload-date').textContent = '';
            document.getElementById('like-count').textContent = '';
            document.getElementById('channel-name').textContent = '';
            document.getElementById('subscriber-count').textContent = '';
            document.getElementById('channel-avatar-player').src = '';
            if (player) player.destroy();
            
            videoIdToLoad = videoId;
            if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                // API is not ready, it will be handled by onYouTubeIframeAPIReady
            } else {
                createPlayer(videoId);
            }

            try {
                const videoDetails = await fetchVideoDetails(videoId);
                const channelDetails = await fetchChannelDetails(videoDetails.channelId);
                const comments = await fetchComments(videoId);

                document.getElementById('video-title-player').textContent = videoDetails.title;
                document.getElementById('video-description').textContent = videoDetails.description;
                document.getElementById('view-count').textContent = `${formatViews(videoDetails.views)} views`;
                document.getElementById('upload-date').textContent = new Date(videoDetails.publishedAt).toLocaleDateString();
                document.getElementById('like-count').textContent = `${formatLikes(videoDetails.likes)} likes`;
                
                document.getElementById('channel-name').textContent = channelDetails.title;
                document.getElementById('subscriber-count').textContent = `${formatSubs(channelDetails.subscribers)} subscribers`;
                document.getElementById('channel-avatar-player').src = channelDetails.avatarUrl;

                displayComments(comments);
            } catch (error) {
                document.getElementById('video-info').innerHTML = `<p style="color: red;">Error loading video details.</p>`;
            }
        }

        function showMainView() {
            mainView.style.display = 'block';
            playerView.style.display = 'none';
            if (player) {
                player.stopVideo();
                player.destroy();
                player = null;
            }
            document.getElementById('player-container').innerHTML = '';
        }

        function displayComments(comments) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';
            if (!comments || comments.length === 0) {
                list.innerHTML = '<p>No comments found.</p>';
                return;
            }
            comments.forEach(comment => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <img src="${comment.authorProfileImageUrl}" alt="${comment.authorDisplayName}">
                    <div class="comment-content">
                        <p class="comment-author">${comment.authorDisplayName}</p>
                        <p>${comment.textDisplay}</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        const formatNumber = (numStr, unit) => {
            if (numStr === "N/A") return "";
            const num = parseInt(numStr, 10);
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M' + unit;
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K' + unit;
            return num + unit;
        };
        const formatViews = (views) => formatNumber(views, '');
        const formatLikes = (likes) => formatNumber(likes, '');
        const formatSubs = (subs) => formatNumber(subs, '');

        async function getChannelAvatars(channelIds) {
            if (channelIds.length === 0) return {};
            const response = await fetch(`${API_BASE}channels?part=snippet&id=${channelIds.join(',')}&key=${YOUTUBE_API_KEY}`);
            if (!response.ok) return {};
            const data = await response.json();
            return data.items.reduce((map, item) => {
                map[item.id] = item.snippet.thumbnails.default.url;
                return map;
            }, {});
        }

        async function fetchVideoDetails(videoId) {
            const response = await fetch(`${API_BASE}videos?part=snippet,statistics&id=${videoId}&key=${YOUTUBE_API_KEY}`);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            if (!data.items || data.items.length === 0) throw new Error("Video not found.");
            
            const video = data.items[0];
            return {
                title: video.snippet.title,
                description: video.snippet.description,
                publishedAt: video.snippet.publishedAt,
                channelId: video.snippet.channelId,
                views: video.statistics.viewCount,
                likes: video.statistics.likeCount,
            };
        }

        async function fetchChannelDetails(channelId) {
            const response = await fetch(`${API_BASE}channels?part=snippet,statistics&id=${channelId}&key=${YOUTUBE_API_KEY}`);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const data = await response.json();
            if (!data.items || data.items.length === 0) throw new Error("Channel not found.");
            
            const channel = data.items[0];
            return {
                title: channel.snippet.title,
                avatarUrl: channel.snippet.thumbnails.default.url,
                subscribers: channel.statistics.subscriberCount,
            };
        }

        async function fetchComments(videoId) {
            const response = await fetch(`${API_BASE}commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&maxResults=20`);
            if (!response.ok) return [];
            const data = await response.json();
            return data.items.map(item => {
                const comment = item.snippet.topLevelComment.snippet;
                return {
                    authorDisplayName: comment.authorDisplayName,
                    authorProfileImageUrl: comment.authorProfileImageUrl,
                    textDisplay: comment.textDisplay,
                };
            });
        }

        async function fetchSearchData(query, pageToken = '') {
            let url = `${API_BASE}search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=12&key=${YOUTUBE_API_KEY}`;
            if (pageToken) url += `&pageToken=${pageToken}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const data = await response.json();
            const videoIds = data.items.map(item => item.id.videoId).join(',');

            if (!videoIds) return { items: [], nextPageToken: data.nextPageToken };

            const statsResponse = await fetch(`${API_BASE}videos?part=statistics&id=${videoIds}&key=${YOUTUBE_API_KEY}`);
            if (!statsResponse.ok) throw new Error(`HTTP Error fetching stats: ${statsResponse.status}`);

            const statsData = await statsResponse.json();
            const statsMap = statsData.items.reduce((map, item) => {
                map[item.id] = item.statistics;
                return map;
            }, {});

            const items = data.items.map(item => {
                const videoId = item.id.videoId;
                const stats = statsMap[videoId] || {};
                return {
                    videoId: videoId,
                    title: item.snippet.title,
                    channel: item.snippet.channelTitle,
                    channelId: item.snippet.channelId,
                    imageUrl: item.snippet.thumbnails.high.url,
                    views: stats.viewCount || "N/A",
                };
            });

            return { items, nextPageToken: data.nextPageToken };
        }
    </script>
</body>
</html>
